<?php

/**
 * @file
 * Pages app.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\node\Entity\Node;
use Drupal\block_visibility_groups\Entity\BlockVisibilityGroup;

/**
 * Implements hook_entity_insert().
 *
 * @throws \Drupal\Core\Entity\EntityStorageException
 */
function os_pages_entity_insert(EntityInterface $entity) {
  /** @var \Drupal\os_pages\VisibilityHelper $visibility_helper */
  $visibility_helper = \Drupal::service('os_pages.visibility_helper');

  if (!$visibility_helper->isBookPage($entity)) {
    return;
  }

  /** @var \Drupal\os_pages\VisibilityStorageInterface $visibility_storage */
  $visibility_storage = \Drupal::service('os_pages.visibility_storage');

  // Create page visibility group.
  $visibility_storage->create([
    'id' => "os_pages_page_{$entity->id()}",
    'label' => t('OS Pages: Page @name', [
      '@name' => $entity->label(),
    ]),
    'status' => TRUE,
    'allow_other_conditions' => TRUE,
    'logic' => 'and',
  ], [
    [
      'id' => 'node_type',
      'bundles' => [
        $entity->bundle() => $entity->bundle(),
      ],
      'negate' => FALSE,
      'context_mapping' => [
        'node' => '@node.node_route_context:node',
      ],
    ],
    [
      'id' => 'request_path',
      'pages' => "/node/{$entity->id()}",
      'negate' => FALSE,
      'context_mapping' => [],
    ],
  ]);

  /** @var \Drupal\node\NodeInterface $book */
  $book = Node::load($entity->book['bid']);

  /** @var \Drupal\block_visibility_groups\Entity\BlockVisibilityGroup|null $section_visibility_group */
  $section_visibility_group = BlockVisibilityGroup::load("os_pages_section_{$book->id()}");

  // Create/update section visibility group.
  if (!$section_visibility_group) {
    if ($visibility_helper->isBookFirstPage($entity)) {
      $visibility_storage->create([
        'id' => "os_pages_section_{$book->id()}",
        'label' => t('OS Pages: Section @book_name', [
          '@book_name' => $book->label(),
        ]),
        'status' => TRUE,
        'allow_other_conditions' => TRUE,
        'logic' => 'and',
      ], [
        [
          'id' => 'node_type',
          'bundles' => [
            $entity->bundle() => $entity->bundle(),
          ],
          'negate' => FALSE,
          'context_mapping' => [
            'node' => '@node.node_route_context:node',
          ],
        ],
        [
          'id' => 'request_path',
          'pages' => "/node/{$book->id()}\n/node/{$entity->id()}",
          'negate' => FALSE,
          'context_mapping' => [],
        ],
      ]);
    }
  }
  else {
    $section_visibility_group->addCondition([
      'id' => 'request_path',
      'pages' => "/node/{$entity->id()}",
      'negate' => 0,
      'context_mapping' => [],
    ]);

    $section_visibility_group->save();
  }
}

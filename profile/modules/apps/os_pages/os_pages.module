<?php

/**
 * @file
 * Pages app.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\block_visibility_groups\Entity\BlockVisibilityGroup;
use Drupal\node\Entity\Node;

/**
 * Implements hook_entity_insert().
 *
 * @throws \Drupal\Core\Entity\EntityStorageException
 */
function os_pages_entity_insert(EntityInterface $entity) {
  /** @var \Drupal\os_pages\VisibilityHelper $visibility_helper */
  $visibility_helper = \Drupal::service('os_pages.visibility_helper');
  /** @var \Drupal\Core\Path\AliasManagerInterface $alias_manager */
  $alias_manager = \Drupal::service('path.alias_manager');

  if ($visibility_helper->shouldCreateSectionVisibilityGroup($entity)) {
    /** @var \Drupal\node\NodeInterface $book */
    $book = Node::load($entity->book['bid']);

    /** @var \Drupal\block_visibility_groups\Entity\BlockVisibilityGroup $visibility_group */
    $visibility_group = BlockVisibilityGroup::create([
      'id' => "os_pages_section_{$book->id()}",
      'label' => t('OS Pages: @book_name', [
        '@book_name' => $book->label(),
      ]),
      'status' => TRUE,
      'allow_other_conditions' => TRUE,
      'logic' => 'and',
    ]);

    $visibility_group->save();

    $visibility_group->addCondition([
      'id' => 'entity_bundle:node',
      'bundles' => [
        'page' => $entity->bundle(),
      ],
      'negate' => FALSE,
    ]);

    $visibility_group->addCondition([
      'id' => 'request_path',
      'pages' => $alias_manager->getAliasByPath("/node/{$entity->id()}"),
      'negate' => 0,
    ]);

    $visibility_group->save();
  }
}
